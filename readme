# prerequisites

# don't forget to use bash because node js doens't work with shell so mirord will not work with shell 
kubectl apply -f ./prerequisites/mongo-express/
kubectl delete -f ./prerequisites/mongo-express/
kubectl port-forward mongo-express-6cfbc86cb6-prfs5 8081:8081

kubectl get pods | grep express | awk '{kubectl exec -it  $1 sh}'
for pod in $(kubectl get pods --no-headers | grep 'express' | awk '{print $1}'); do
    kubectl port-forward "$pod" 8081:8081
done
# keda install 
helm repo add kedacore https://kedacore.github.io/charts
helm repo update
helm install keda kedacore/keda --namespace keda --create-namespace

# uninstall
kubectl delete $(kubectl get scaledobjects.keda.sh,scaledjobs.keda.sh -A \
  -o jsonpath='{"-n "}{.items[*].metadata.namespace}{" "}{.items[*].kind}{"/"}{.items[*].metadata.name}{"\n"}')
helm uninstall keda -n keda

for i in $(kubectl get scaledobjects -A \
  -o jsonpath='{"-n "}{.items[*].metadata.namespace}{" "}{.items[*].kind}{"/"}{.items[*].metadata.name}{"\n"}');
do kubectl patch $i -p '{"metadata":{"finalizers":null}}' --type=merge
done

for i in $(kubectl get scaledjobs -A \
  -o jsonpath='{"-n "}{.items[*].metadata.namespace}{" "}{.items[*].kind}{"/"}{.items[*].metadata.name}{"\n"}');
do kubectl patch $i -p '{"metadata":{"finalizers":null}}' --type=merge
done